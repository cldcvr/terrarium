name: Checks

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

env:
  TR_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Run default Setup
        run: |
          make farm-release-pull
          make docker-init docker-build docker-run
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: API Health Check
        uses: jtalk/url-health-check-action@v3
        with:
          url: http://localhost:3000/v0/healthcheck
          max-attempts: 60
          retry-delay: 1s
          retry-all: true

      - name: Print container logs
        if: failure()
        run: |
          echo Printing terrarium-api container logs
          docker logs terrarium-api || echo ""

          echo Printing postgres container logs
          docker logs postgres || echo ""

      - name: Run unit tests
        run: |
          rm -f data/cc_terrarium.psql
          make docker-stop-clean docker-api-test

      - name: Check harvest script
        run: |
          rm -f data/cc_terrarium.psql
          make docker-stop-clean docker-harvest
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
