# Copyright (c) Ollion
# SPDX-License-Identifier: Apache-2.0

profiles:
    - id: dev
      title: Development Configuration
      description: Infrastructure configuration optimized for development deployment.
    - id: prod
      title: Production Configuration
      description: Infrastructure configuration optimized for production deployment.
components:
    - id: job_queue
      title: Queue Job
      description: A job that performs tasks in the queue.
      inputs:
        type: object
      outputs:
        type: object
        properties:
            task_queue:
                title: Task Queue
                description: The queue from which the job pulls tasks.
    - id: job_scheduled
      title: Scheduled Job
      description: A job that is run at scheduled intervals.
      inputs:
        type: object
        properties:
            schedule:
                title: Schedule
                description: The schedule on which the job should run, in cron format.
                type: string
                default: 0 0 12 * * ?
      outputs:
        type: object
    - id: postgres
      title: PostgreSQL Database
      description: A relational database management system using SQL.
      inputs:
        type: object
        properties:
            db_name:
                title: Database Name
                description: The name provided here may get prefix and suffix based
                type: string
                default: default_db
            version:
                title: Version
                description: Version of the PostgreSQL engine to use
                type: string
                default: "11"
                enum:
                    - "11"
                    - "12"
                    - "13"
      outputs:
        type: object
        properties:
            host:
                title: Host
                description: The host address of the PostgreSQL server.
            password:
                title: Password
                description: The password for accessing the PostgreSQL database.
            port:
                title: Port
                description: The port number on which the PostgreSQL server is listening.
            username:
                title: Username
                description: The username for accessing the PostgreSQL database.
    - id: redis
      title: Redis Cache
      description: An in-memory data structure store used as a cache or message broker.
      inputs:
        type: object
        properties:
            version:
                title: Version
                description: Version of the Redis engine to use
                type: string
                default: 5.0.6
      outputs:
        type: object
        properties:
            host:
                title: Host
                description: The host address of the Redis server.
            password:
                title: Password
                description: The password for accessing the Redis database.
            port:
                title: Port
                description: The port number on which the Redis server is listening.
    - id: server_private
      title: Private Server
      description: A server that is not exposed to the public internet.
      inputs:
        type: object
        properties:
            port:
                title: Port
                description: The port number on which the server should listen.
                type: number
                default: 80
      outputs:
        type: object
        properties:
            host:
                title: Host
                description: The host address of the private server.
    - id: server_static
      title: Static Server
      description: A server that hosts and serves static files.
      inputs:
        type: object
        properties:
            port:
                title: Port
                description: The port number on which the server should listen.
                type: number
                default: 80
      outputs:
        type: object
        properties:
            host:
                title: Host
                description: The host address of the static server.
    - id: server_web
      title: Web Server
      description: A server that hosts web applications and handles HTTP requests.
      inputs:
        type: object
        properties:
            port:
                title: Port
                description: The port number on which the server should listen.
                type: number
                default: 80
      outputs:
        type: object
        properties:
            host:
                title: Host
                description: The host address of the web server.
graph:
    - id: local.azs
      requirements: []
    - id: local.database_enabled
      requirements:
        - local.tr_component_postgres
    - id: local.elasticache_enabled
      requirements:
        - local.tr_component_redis
    - id: local.tr_component_job_queue
      requirements: []
    - id: local.tr_component_job_scheduled
      requirements: []
    - id: local.tr_component_postgres
      requirements: []
    - id: local.tr_component_redis
      requirements: []
    - id: local.tr_component_server_private
      requirements: []
    - id: local.tr_component_server_static
      requirements: []
    - id: local.tr_component_server_web
      requirements: []
    - id: module.core_vpc
      requirements:
        - local.azs
        - local.database_enabled
        - local.elasticache_enabled
    - id: module.job_queue_runner
      requirements:
        - local.tr_component_job_queue
        - module.k8s_cluster
    - id: module.job_scheduled_runner
      requirements:
        - local.tr_component_job_scheduled
        - module.k8s_cluster
    - id: module.k8s_cluster
      requirements: []
    - id: module.postgres_security_group
      requirements:
        - module.core_vpc
    - id: module.tr_component_job_queue
      requirements:
        - local.tr_component_job_queue
        - module.job_queue_runner
    - id: module.tr_component_job_scheduled
      requirements:
        - local.tr_component_job_scheduled
        - module.job_scheduled_runner
    - id: module.tr_component_postgres
      requirements:
        - local.tr_component_postgres
        - module.core_vpc
        - module.postgres_security_group
        - var.all_db_instance_class
        - var.db_instance_class
    - id: module.tr_component_redis
      requirements:
        - local.azs
        - local.tr_component_redis
        - module.core_vpc
    - id: module.tr_component_server_private
      requirements:
        - local.tr_component_server_private
        - module.k8s_cluster
    - id: module.tr_component_server_static
      requirements:
        - local.tr_component_server_static
    - id: module.tr_component_server_web
      requirements:
        - local.tr_component_server_web
        - module.k8s_cluster
    - id: output.random_always
      requirements:
        - resource.random_string.random_always
    - id: output.random_never
      requirements:
        - resource.random_string.random_never
    - id: output.tr_component_job_queue_task_queue
      requirements:
        - module.tr_component_job_queue
    - id: output.tr_component_postgres_host
      requirements:
        - module.tr_component_postgres
    - id: output.tr_component_postgres_password
      requirements:
        - module.tr_component_postgres
    - id: output.tr_component_postgres_port
      requirements:
        - module.tr_component_postgres
    - id: output.tr_component_postgres_username
      requirements:
        - module.tr_component_postgres
    - id: output.tr_component_redis_host
      requirements:
        - module.tr_component_redis
    - id: output.tr_component_redis_password
      requirements:
        - module.tr_component_redis
    - id: output.tr_component_redis_port
      requirements:
        - module.tr_component_redis
    - id: output.tr_component_server_private_host
      requirements:
        - module.tr_component_server_private
    - id: output.tr_component_server_static_host
      requirements:
        - module.tr_component_server_static
    - id: output.tr_component_server_web_host
      requirements:
        - module.tr_component_server_web
    - id: output.vpc_id
      requirements:
        - module.core_vpc
    - id: provider.random
      requirements: []
    - id: resource.random_string.random_always
      requirements:
        - provider.random
    - id: resource.random_string.random_never
      requirements:
        - provider.random
    - id: var.all_db_instance_class
      requirements: []
    - id: var.db_instance_class
      requirements: []
